# Trajectory Analysis

A series of scripts and tools to compare trajectories among each other.

## Inputs

### Trajectories

Provided as CSV-file with the structure:

1. Pose Series (`pose`)
  ```
  # timestamp, x, y, z, qx, qy, qz, qw
  ```
  Where the  `timestamp` is in nanoseconds; `x`, `y`, `z` are metric and `qx`, `qy`, `qz`, `qw` are the elements of a unit quaternion.

2. `swe`
  ```
  # timestamp, x, y, z, qx, qy, qz, qw, vx, vy, vz, bgx, bgy, bgz, bax, bay, baz
  ```
  The first 7 components are equivalent to the pose series representation. `vx`, `vy`, `vz` are the componenents of the velocity. `bgx`, `bgy`, `bgz` the bias of the gyroscope and `bax`, `bay` and `baz` the bias of the accelerometer.

3. `euroc`
  ```
  #timestamp, p_RS_R_x [m], p_RS_R_y [m], p_RS_R_z [m], q_RS_w [], q_RS_x [], q_RS_y [], q_RS_z [], v_RS_R_x [m s^-1], v_RS_R_y [m s^-1], v_RS_R_z [m s^-1], b_w_RS_S_x [rad s^-1], b_w_RS_S_y [rad s^-1], b_w_RS_S_z [rad s^-1], b_a_RS_S_x [m s^-2], b_a_RS_S_y [m s^-2], b_a_RS_S_z [m s^-2]
  ```

### Hand-Eye Calibration
Specified as yaml file with the keys:
```
T_sensor_trackable:
  qx: ...
  qy: ... 
  qz: ... 
  qw: ...
  tx: ...
  ty: ...
  tz: ...
```
Again, `tx`, `ty` and `tz` are the matric translational values and `qx`, `qy`, `qz`, `qw` represent a unit quaternion. The transformation matrix described by `t_` and `q_` is `T_B_H`, transforming point from the frame of the "Hand" to the body-frame.

### Naming conventions in data directory:
The scripts expect a rather strict naming convention in the data directory:
* `traj_gt.csv`: the groundtruth trajectory,
* `traj_es.csv`: the estimated trajectory to evaluate,
* `traj_es_gt_matches.csv`: [optional] this file is automatically generated when running `analyse.py` but if provided, it will skip this computation.

## Common Tasks

### Trajectory Analysis (`analyse.py`)

Takes a results folder with groundtruth and estimated trajectories, aligns them and generates a series of statistics and plots.

Command line arguments:
```
--data_dir: Full path to the directory containing the result files (traj_gt.csv, traj_es.csv)
--format_gt: Format of the provided ground-truth [swe, pose, euroc] (Defalt: pose)
--format_es: Format of the estimate [swe, pose, euroc] (Default: pose)
--alignment: Trajectory alignment to perform (Default: se3):
             - se3: Estimate a 3d transform that minimizes the squared error between the groundtruth and estimated trajectory.
             - sim3: Estimate a 3d transform and a scaling factor that minimizes the squared error between the groundtruth and estimated trajectory.
             - first_frame: align the starting pose of the two trajectories.
--alignment_first_frame: the first frame to consider for trajectory alignment (Default: 0)
--alignment_last_frame: the last frame to consider for trajectory alignment, -1 for disabled. (Default: -1)
--plot_size: Scaling factor for the plots (Default: 0.2)
--skip_frames: Number of frames to skip between segment evaluations (Default: 1)
```

### Compare two results folders (`compare.py`)

Takes two results folders performs a comparative analysis on the two.

Command line arguments:
```
--trace_dir: full path to the results to compare to the reference
--reference: full path to the results that serve as reference for trace
```
The results folder must contain a `job.yaml` with at least an `experiment_name` key.

## Relative errors (`relative_errors.py`)

Compure relative errors of two trajectories with respect to different segment lengths along the trajectory.

Command line arguments:
```
--data_dir: Full path to the directory containing the results
--format_gt: Format of the provided ground-truth [swe, pose, euroc] (Defalt: pose)
--format_es: Format of the estimate [swe, pose, euroc] (Default: pose)
--skip_frames: Number of frames to skip between segment evaluations (Default: 1)
--segment_lengths: The segments lengths to split the trajectory into for statistical evaluations as comma separated string (Default: 10, 40, 90, 160)
--segment_align_lsq: Align every segment pair to minimize the squared errors (on SE3)
--segment_align_lsq_translation_only:  Align every segment pair considering only translations
--plot_size: Scaling factor for the plots (Default: 0.2)
--plot_errors_along_trajectory: Plot the relative errors along the trajectory (Default: False)
```


